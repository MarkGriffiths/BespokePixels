<!DOCTYPE html>

<html>
<head>
  <title>gulpfile.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>gulpfile.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*
 *  BespokePixels Gulp File
 */</span>
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>const fs = require(‘fs’)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>)

<span class="hljs-keyword">const</span> gulp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gulp'</span>)
<span class="hljs-keyword">const</span> gutil = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gulp-util'</span>)
<span class="hljs-keyword">const</span> shell = <span class="hljs-built_in">require</span>(<span class="hljs-string">'shelljs'</span>)
<span class="hljs-keyword">const</span> yaml = <span class="hljs-built_in">require</span>(<span class="hljs-string">'js-yaml'</span>)
<span class="hljs-keyword">const</span> plist = <span class="hljs-built_in">require</span>(<span class="hljs-string">'plist'</span>)
<span class="hljs-keyword">const</span> through = <span class="hljs-built_in">require</span>(<span class="hljs-string">'through2'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>const promisify = require(‘es6-promisify’)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">const</span> $ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gulp-load-plugins'</span>)()
<span class="hljs-keyword">const</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>)

<span class="hljs-keyword">const</span> TemplateHelper = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/template-helper-class'</span>)
<span class="hljs-keyword">const</span> OpenColorHelper = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/opencolor-helper-class'</span>)

<span class="hljs-keyword">const</span> config = yaml.safeLoad(shell.cat(<span class="hljs-string">'source/data/config.yaml'</span>))

<span class="hljs-keyword">const</span> uuid = a =&gt; a ?
	((a ^	crypto.randomBytes(<span class="hljs-number">1</span>)[<span class="hljs-number">0</span>] % <span class="hljs-number">16</span>)	&gt;&gt; a / <span class="hljs-number">4</span>).toString(<span class="hljs-number">16</span>) :
	([<span class="hljs-number">1e7</span>] +	<span class="hljs-number">-1e3</span> + <span class="hljs-number">-4e3</span> + <span class="hljs-number">-8e3</span> +	<span class="hljs-number">-1e11</span>).replace(<span class="hljs-regexp">/[018]/g</span>, uuid)

<span class="hljs-keyword">const</span> palette = <span class="hljs-keyword">new</span> OpenColorHelper(<span class="hljs-string">`<span class="hljs-subst">${__dirname}</span>/source/palettes`</span>)
	.loadAll(shell.find(<span class="hljs-string">'source/palettes'</span>).map(path_ =&gt; path.resolve(path_)))

<span class="hljs-keyword">const</span> preparePalette = palette_ =&gt; palette_.transformColors([<span class="hljs-string">'sublRGBA'</span>, <span class="hljs-string">'hexRGBA'</span>])

<span class="hljs-keyword">const</span> plistConverter = () =&gt; through.obj(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">file, enc, cb</span>) </span>{
	<span class="hljs-keyword">if</span> (file.isNull()) {
		<span class="hljs-keyword">return</span> cb(<span class="hljs-literal">null</span>, file)
	}
	<span class="hljs-keyword">if</span> (file.isStream()) {
		<span class="hljs-keyword">return</span> cb(<span class="hljs-keyword">new</span> gutil.PluginError(<span class="hljs-string">'Theme compiler'</span>, <span class="hljs-string">'Streaming not supported'</span>))
	}
	<span class="hljs-keyword">try</span> {
		file.contents = <span class="hljs-keyword">new</span> Buffer(plist.build(<span class="hljs-built_in">JSON</span>.parse(file.contents)))
		<span class="hljs-keyword">this</span>.push(file)
	} <span class="hljs-keyword">catch</span> (err) {
		<span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'error'</span>, <span class="hljs-keyword">new</span> gutil.PluginError(<span class="hljs-string">'Theme compiler @plistConverter'</span>, err, {fileName: file.path}))
	}
	cb()
})

<span class="hljs-keyword">const</span> setData = mode_ =&gt; through.obj(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">file, enc, cb</span>) </span>{
	<span class="hljs-keyword">if</span> (file.isNull()) {
		<span class="hljs-keyword">return</span> cb(<span class="hljs-literal">null</span>, file)
	}
	<span class="hljs-keyword">if</span> (file.isStream()) {
		<span class="hljs-keyword">return</span> cb(<span class="hljs-keyword">new</span> gutil.PluginError(<span class="hljs-string">'Theme compiler'</span>, <span class="hljs-string">'Streaming not supported'</span>))
	}
	<span class="hljs-keyword">try</span> {
		file.extname = <span class="hljs-string">`.<span class="hljs-subst">${file.data.extname[mode_]}</span>`</span>
		file.stem = <span class="hljs-string">`<span class="hljs-subst">${file.data.stem}</span><span class="hljs-subst">${file.data.ui_variant}</span>`</span>
		<span class="hljs-keyword">this</span>.push(file)
	} <span class="hljs-keyword">catch</span> (err) {
		<span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'error'</span>, <span class="hljs-keyword">new</span> gutil.PluginError(<span class="hljs-string">'Theme compiler @setData'</span>, err, {fileName: file.path}))
	}
	cb()
})

gulp.task(<span class="hljs-string">'default'</span>, () =&gt; palette
	.then(preparePalette)
	.then(p_ =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>console.dir(p_.pick(), {
    depth: 2,
    colors: true
})</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
		<span class="hljs-built_in">console</span>.log(p_.render())
	})
)

gulp.task(<span class="hljs-string">'compile:settings'</span>, () =&gt; gulp.src([<span class="hljs-string">'source/settings/*.json'</span>])
	.pipe($.include())
	.pipe($.data(file_ =&gt; {
		<span class="hljs-keyword">const</span> basename = path.basename(file_.path, <span class="hljs-string">'.json'</span>)
		<span class="hljs-keyword">const</span> variantConfig = yaml.safeLoad(shell.cat(<span class="hljs-string">`source/data/default.yaml`</span>))

		<span class="hljs-built_in">console</span>.info(<span class="hljs-string">`Compiling <span class="hljs-subst">${config[basename].stem}</span> settings...`</span>)

		<span class="hljs-keyword">const</span> jobConfig = _.merge({basename, uuid: uuid()},
			config, variantConfig, palettes.default, config[basename])

		<span class="hljs-keyword">return</span> _.merge(jobConfig,
			yaml.safeLoad(_.template(
				shell.cat(<span class="hljs-string">`source/data/template.yaml`</span>)
			)(jobConfig)
		))
	}))
	.pipe($.template())
	.pipe(setData(<span class="hljs-string">'settings'</span>))
	.pipe(gulp.dest(<span class="hljs-string">'./settings'</span>))
)</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>gulp.task(‘compile:syntax’, () =&gt; gulp.src([‘source/syntax/*.yaml’])
    .pipe($.include())
    .pipe($.data(file<em> =&gt; {
        const basename = path.basename(file</em>.path, ‘.yaml’)
        const variantConfig = yaml.safeLoad(shell.cat(<code>source/data/default.yaml</code>))</p>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <pre><code>    <span class="hljs-built_in">console</span>.info(<span class="hljs-string">`Compiling <span class="hljs-subst">${config[basename].stem}</span> syntax files.`</span>)
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <pre><code>    <span class="hljs-keyword">const</span> jobConfig = _.merge({basename, uuid: uuid()},
        config, variantConfig, palettes.default, config[basename])
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <pre><code>    <span class="hljs-keyword">return</span> _.merge(jobConfig,
        yaml.safeLoad(_.template(
            shell.cat(<span class="hljs-string">`source/data/template.yaml`</span>)
        )(jobConfig)
    ))
}))
.pipe($.template())
.pipe(setData(<span class="hljs-string">'syntax'</span>))
.pipe(gulp.dest(<span class="hljs-string">'./syntax'</span>))
</code></pre><p>)</p>

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>gulp.task(‘compile:scheme’, gulp.parallel(
    <em>.map(palettes, (palette</em>, name<em>) =&gt; function colourScheme() {
        const variantConfig = yaml.safeLoad(shell.cat(`source/data/${name</em>}.yaml`))</p>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <pre><code>    <span class="hljs-keyword">return</span> gulp.src(<span class="hljs-string">'source/schemes/*.yaml'</span>)
        .pipe($.include())
        .pipe($.data(file_ =&gt; {
            <span class="hljs-keyword">const</span> basename = path.basename(file_.path, <span class="hljs-string">'.yaml'</span>)
            <span class="hljs-built_in">console</span>.info(<span class="hljs-string">`Compiling <span class="hljs-subst">${config[basename].stem}</span> colour scheme for <span class="hljs-subst">${name_}</span> variant.`</span>)
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <pre><code>            <span class="hljs-keyword">const</span> processConfig = variantPalette_ =&gt; {
                <span class="hljs-keyword">const</span> jobConfig = _.merge({basename, uuid: uuid()},
                    config, variantConfig, palette_, variantPalette_, config[basename])
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <pre><code>                <span class="hljs-keyword">return</span> _.merge(jobConfig, yaml.safeLoad(_.template(
                    shell.cat(<span class="hljs-string">`source/data/template.yaml`</span>)
                )(jobConfig)))
            }
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(resolve =&gt; {
                stat(palettePath)
                .then(() =&gt; resolve(processConfig(paintBox(
                    <span class="hljs-built_in">require</span>(<span class="hljs-string">'require-all'</span>)({
                        dirname: palettePath,
                        recursive: <span class="hljs-literal">true</span>
                    })
                ))))
                .catch(() =&gt; resolve(processConfig({})))
            })
        }))
        .pipe($.template())
        .pipe(setData(<span class="hljs-string">'editable'</span>))
        .pipe(gulp.dest(<span class="hljs-string">'./schemes'</span>))
        .pipe($.yaml({space: <span class="hljs-number">2</span>}))
        .pipe(plistConverter())
        .pipe(setData(<span class="hljs-string">'scheme'</span>))
        .pipe(gulp.dest(<span class="hljs-string">'./schemes'</span>))
})
</code></pre><p>))</p>

            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>gulp.task(‘compile:theme’, gulp.parallel(
    <em>.map(palettes, (palette</em>, name<em>) =&gt; function uiTheme() {
        const variantConfig = yaml.safeLoad(shell.cat(`source/data/${name</em>}.yaml<code>))
        return gulp.src(&#39;source/themes/theme.json&#39;)
            .pipe($.include())
            .pipe($.data(() =&gt; {
                console.info(</code>Compiling ${config.theme.stem} settings for ${name_} variant.`)</p>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <pre><code>            <span class="hljs-keyword">const</span> jobConfig = _.merge({basename: <span class="hljs-string">'theme'</span>, uuid: uuid()},
                config, variantConfig, palette_, config.theme)
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <pre><code>            <span class="hljs-keyword">return</span> _.merge(jobConfig,
                yaml.safeLoad(_.template(
                    shell.cat(<span class="hljs-string">`source/data/template.yaml`</span>)
                )(jobConfig)
            ))
        }))
        .pipe($.template())
        .pipe(setData(<span class="hljs-string">'theme'</span>))
        .pipe(gulp.dest(<span class="hljs-string">'./'</span>))
})
</code></pre><p>))</p>

            </div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
